<!--Heading starts-->
<app-data-loader *ngIf="isLoading"></app-data-loader>
<div *ngIf="!isLoading" class="flex flex-col px-12 py-12 pb-2">
    <ng-container>
        <div class="flex justify-between">
            <h2>Link R-R {{("Task" | labelReplacement)| async}}s</h2>
            <app-button ButtonType="icon" icon="close" (clicked)="closed.emit('fp-sh-task-link-closed')"></app-button>
        </div>
        <div class="r5-marking-header" *ngIf="linkedIds.length>0">
            <span class="selected-tasks-caption"><span class="selected-count">{{linkedIds.length}}</span> {{("Task" | labelReplacement)| async}}s selected</span>
            <app-button class="p-1" color="secondary"  text="Mark as R5 Impact" size="sm" (clicked)="openR5MarkDialogue(markR5Tasks)">
            </app-button>
        </div>
        <div class="selected-tasks-list">
            <div class="selected-task-header">Selected {{("Task" | labelReplacement)| async}}s</div>
            <mat-table  [dataSource]="selectedTaskData">
                <ng-container matColumnDef="number">
                    <mat-cell *matCellDef="let row">
                        <span *ngIf="row.active">{{row.number}}</span>
                        <span *ngIf="!row.active" class="italic text-gray-four">{{row.number}}</span>
                    </mat-cell>
                </ng-container>
                <ng-container matColumnDef="description">

                    <mat-cell *matCellDef="let row" class="justify-content-start">
                        <span *ngIf="row.active">{{row.description}} </span>
                        <span *ngIf="!row.active" class="italic text-gray-four">{{row.description}} </span>
                    </mat-cell>
                </ng-container>

                <mat-row *matRowDef="let row; columns: displayColumns;" [class.inActiveItem]="!row.active"></mat-row>
                <tr class="mat-row flex text-center " *matNoDataRow>
                    <td class="mat-cell w-full m-2">No data to display</td>
                </tr>
            </mat-table>
        </div>
    </ng-container>
</div>


<div class="flex flex-col px-12 py-2" *ngIf="selectedTasks.length == 1 && selectedTasks[0].isR5Impacted && !isLoading">
    <ng-container> 
      <div class="marking-instructions-all">
          <span> Following R-R {{("Task" | labelReplacement)| async}}s are linked to the selected {{("Task" | labelReplacement)| async}}:</span>
          <app-button  variant="text" icon="link_off" iconPosition="left" style="cursor: pointer!important" text="Unlink All" (clicked)="unlinkR5Tasks(unlinkAllR5ImpactedTasks,selectedTasks[0].positionTaskId)"></app-button>
      </div>
      <div class="impacted-tasks-list">
          <mat-table matSortActive="number" matSortDirection="asc" matSort [dataSource]="impactedTaskData" (matSortChange)="sortTable()">
              <ng-container matColumnDef="number">
                <mat-header-cell *matHeaderCellDef mat-sort-header> #
                </mat-header-cell>
                <mat-cell *matCellDef="let row" >
                  <span *ngIf="row.active">{{row.impactedTaskFullNumber}}</span>
                  <span *ngIf="!row.active" class="italic text-gray-four">{{row.impactedTaskFullNumber}}</span>
                </mat-cell>
              </ng-container>
              <ng-container matColumnDef="description" >
                <mat-header-cell *matHeaderCellDef mat-sort-header class="px-2"> {{("Task" | labelReplacement)| async}} Statement
                </mat-header-cell>
                <mat-cell *matCellDef="let row" class="justify-content-start">
                  <span *ngIf="row.active">{{row.impactedTaskDescription}}</span>
                  <span *ngIf="!row.active" class="italic text-gray-four">{{row.impactedTaskDescription}} </span>
                </mat-cell>
              </ng-container>
              <ng-container matColumnDef="action" >
                <mat-header-cell *matHeaderCellDef mat-sort-header class="px-2">
                </mat-header-cell>
                <mat-cell *matCellDef="let row">
                  <app-button  ButtonType="icon" icon="link_off" style="color:lightgray" (clicked)="unlinkR5Task(row,unlinkR5TaskDialogue)">
                    </app-button>
                </mat-cell>
              </ng-container>
              <mat-header-row *matHeaderRowDef="impactedDisplayColumns"></mat-header-row>
              <mat-row *matRowDef="let row; columns: impactedDisplayColumns;" [class.inActiveItem]="!row.active"></mat-row>
              <!-- Row shown when there is no matching data.-->
              <tr class="mat-row flex text-center " *matNoDataRow>
                <td class="mat-cell w-full m-2" style="border: 0;">No data to display</td>
              </tr>
            </mat-table>
      </div>
      <div class="impacted-task-reason">
        <h3>Reason</h3>
        <p>These {{("Task" | labelReplacement)| async}}s will be impacted if the performance on the {{("Task" | labelReplacement)| async}} {{selectedTasks[0].number}} is not in accordance with the standards...</p>
      </div>
    </ng-container>
  </div>
  


<div class="flex flex-col px-12 py-12" *ngIf="!isLoading">
    <ng-container>
        <div class="flex flex-row justify-between">
            <h2>Select the R-R {{("Task" | labelReplacement)| async}}s that are impacted by the {{("Task" | labelReplacement)| async}}(s) listed above</h2>

        </div>
        <div class="flex flex-row items-center border-b-0.8 border-gray-one">
            <div class="flex flex-grow">
                <app-icon icon="search"></app-icon>
                <input class="text-sm flex-grow focus:outline-none" placeholder="Search" type="text"
                    (input)="filterTaskTreeData()" [(ngModel)]="filterTaskString">

                <app-icon icon="close" class="cursor-pointer" (click)="clearFilter()"></app-icon>
                
            </div>
            <div>
                <app-button class="p-1"  icon_pos color="secondary" text="Filter " size="sm" (click)="openFlyPanelLink()">
                </app-button>
            </div>
        </div>

        <app-spinner *ngIf="isTaskLoading"></app-spinner>
        <ng-container *ngIf="isTaskAvailable">
            <div class="flex flex-col ">
                <mat-tree [dataSource]="dataSource" [treeControl]="treeControl" class="qtd-tree">
                    <!-- This is the tree node template for leaf nodes -->
                    <!-- There is inline padding applied to this node using styles.
                            This padding value depends on the mat-icon-button width. -->
                    <mat-tree-node *matTreeNodeDef="let node" matTreeNodeToggle matTreeNodePadding
                        [style.display]="showOnlySelected && !node.selected || hideLeafNode(node) ? 'none' : 'block'">
                        <ng-container *ngIf="node.checkbox">
                            <mat-checkbox (change)="onTaskChange($event,node)" [checked]="node.selected">
                                {{node.description}}</mat-checkbox>
                        </ng-container>
                        <ng-container *ngIf="!node.checkbox">
                            <app-icon style="color: rgb(92, 155, 49);" icon="link"></app-icon>&nbsp;<span
                                style="color: rgb(92, 155, 49);"> <span
                                    class="ml-2 pb-2"></span>{{node.description}}</span>
                        </ng-container>
                    </mat-tree-node>

                    <!-- This is the tree node template for expandable nodes -->
                    <mat-nested-tree-node *matTreeNodeDef="let node; when: hasChild"
                        [style.display]="showOnlySelected && !(node.selected || node.indeterminate) || hideParentNode(node) ? 'none' : 'block'">
                        <div class="mat-tree-node">
                            <button mat-icon-button matTreeNodeToggle [attr.aria-label]="'Toggle ' + node.description">
                                <app-icon [icon]="treeControl.isExpanded(node) ? 'expand_more' : 'chevron_right'">
                                </app-icon>
                            </button>

                            <mat-checkbox [checked]="node.selected"
                                [indeterminate]="node.indeterminate && !node.selected"
                                (change)="itemToggle($event.checked,node)">{{node.description}}</mat-checkbox>
                        </div>

                        <div *ngIf="treeControl.isExpanded(node)" role="group">
                            <ng-container matTreeNodeOutlet></ng-container>
                        </div>
                    </mat-nested-tree-node>
                </mat-tree>
            </div>
        </ng-container>
    </ng-container>
</div>

<ng-template #markR5Tasks>
    <app-qtd-dialogue header="Link R-R {{('Task' | labelReplacement)| async}}s" [reasonDescription]="modalReason" [description]="modalDescription" cancelText="No" confirmText="Yes"
        [showEffectiveDateAndReason]="true" [reasonOnly]="true" (canceled)="dialog.closeAll()" (confirmed)="getDataAsync($event)">
    </app-qtd-dialogue>
  </ng-template>
  <ng-template #unlinkR5TaskDialogue>
    <app-qtd-dialogue header="Unlink {{('Task' | labelReplacement)| async}}" [description]="unlinkR5Description" cancelText="No" confirmText="Yes"
        [showEffectiveDateAndReason]="true" (canceled)="dialog.closeAll()" (confirmed)="getDataR5Unlink($event)">
    </app-qtd-dialogue>
  </ng-template>
  <ng-template #unlinkAllR5ImpactedTasks>
    <app-dialogue-unlink-r5-tasks header="Unlink {{('Task' | labelReplacement)| async}}s" cancelText="No" confirmText="Yes" [r5TasksToUnlink]="r5TaskToUnlink"
        [showEffectiveDateAndReason]="true" (canceled)="dialog.closeAll()" (confirmed)="getDataR5Unlinks($event)">
    </app-dialogue-unlink-r5-tasks>
  </ng-template>

<div class="flypanel-outer-wrapper"  *ngIf="isFlyPanelOpen">
    <div class="flypanel flex flex-col px-12 py-12 ng-star-inserted">
    <app-fly-panel-link-position-filter  (clicked)="handleFlyPanelClicked($event)"   (DutyAreaId)="handleDutyAreaId($event)"
    (subDutyAreaId)="handleSubDutyAreaId($event)" (selectedPosition)="handleSelectedPosition($event)" (setButtonClicked)="filterTaskTreeData()"
    [inputDutyAreaId]="dutyAreaId" [inputSubDutyAreaId]="subDutyAreaId" [inputSelectedPosition]="position"></app-fly-panel-link-position-filter>
    </div>
</div>