<!-- <app-data-loader *ngIf="eo === undefined || steps === undefined"></app-data-loader> -->
<!-- <ng-container *ngIf="eo !== undefined && steps !== undefined"> -->
<ng-container *ngIf="steps !== undefined">
<div class="mainGrid w-full">
  <div class="flex flex-col w-full">
    <div class="mainBorder pr-5">
      <div class="flex flex-row justify-between">
        <div class="flex flex-col m-0">
          <h2 class="mb-2">Steps</h2>
          <p *ngIf="steps !== undefined" class="text-xs" class="text-gray-400">Showing {{steps.length}} Step(s)</p>
        </div>
        <div *ngIf="steps !== undefined">
          <div class="flex flex-row gap-3 mt-3">
            <app-button [disabled]="!isActive" [matMenuTriggerFor]="addNewMenu" variant="text" icon="add"
              iconPosition="left" text="Add new">
            </app-button>
            <app-icon class="text-gray-500" icon="more_horiz" [matMenuTriggerFor]="menu"></app-icon>
            <mat-menu #menu="matMenu">
              <label>Add Events here</label>
            </mat-menu>
            <mat-menu #addNewMenu>

              <label mat-menu-item (click)="openFlyPanel(stepPanel)" class="cursor-pointer">Step</label>
              <label mat-menu-item (click)="openFlyPanel(questionPanel)" class="cursor-pointer">Question And
                Answers</label>
              <label mat-menu-item (click)="openFlyPanel(suggestionPanel)" class="cursor-pointer">SQ Specific
                Suggestions</label>
            </mat-menu>
          </div>
        </div>
      </div>
      <app-data-loader *ngIf="steps === undefined"></app-data-loader>
      <div cdkDropList (cdkDropListDropped)="drop($event)" class="flex flex-col">
        <div cdkDrag [cdkDragDisabled]="savingOrder" *ngFor="let item of steps,index as i">
          <div class=" bg-white shadow-sm p-3 overflow-hidden w-full mt-3">
            <div class="flex flex-row justify-between">
              <div class="flex flex-row gap-1">
                <app-icon cdkDragHandle class="pt-4 mr-2" icon="drag_indicator"
                  style="color: darkgrey!important;cursor:move">
                </app-icon>
                <p class="m-0 text-sm font-bold">Step {{i+1}}</p>
                <!-- <p class="text-xs m-1 text-gray-400">Created May 05, 2021 by Lucy</p> -->
              </div>
              <div>
                <app-icon icon="more_horiz" [matMenuTriggerFor]="stepMenu"></app-icon>
                <mat-menu #stepMenu>
                  <label mat-menu-item [disabled]="!isActive" class="cursor-pointer"
                    (click)="openStepFlyPanel(addStep,item,i)">Edit</label>
                  <label mat-menu-item [disabled]="!isActive" class="cursor-pointer"
                    (click)="deleteStep(deleteDialog,item.id)">Delete</label>
                  
                </mat-menu>
              </div>
            </div>
            <div class="mt-4 ml-4 mr-0 w-fit">
              <div [innerHtml]="item.description"></div>
              <app-button *ngIf="images[i] !== undefined"
                [text]="(collapseImage[i] ? 'Collapse' : 'Expand' )+ ' attached Image'"
                (clicked)="collapseImage[i] = !collapseImage[i]" variant="text"
                [icon]="collapseImage[i] ? 'expand_more': 'expand_less'"></app-button>
              <span class="text-gray-500 text-sm" *ngIf="images[i] === undefined">No Image Attached</span>
              <div *ngIf="collapseImage[i]" [innerHtml]="images[i]"></div>
            </div>
          </div>
        </div>
      </div>
    </div>
    <div class="mainBorder pr-5 pt-4">
      <div class="flex flex-row justify-between">
        <div class="flex flex-col m-0">
          <h2 class="mb-2">Question Answers</h2>
          <p class="text-xs" class="text-gray-400">Showing {{questions.length}} Question Answers</p>
        </div>
      </div>
      <div class="flex flex-col">
        <table cdkDropList mat-table [dataSource]="Datasource" class="table-bordered ">
          <ng-container matColumnDef="order">
            <mat-header-cell *matHeaderCellDef> Reorder
            </mat-header-cell>
            <mat-cell *matCellDef="let row">
              <app-icon cdkDragHandle class="pt-0 mr-2" icon="drag_indicator"
                style="color: darkgrey!important;cursor:move"></app-icon>
            </mat-cell>
          </ng-container>
          <ng-container matColumnDef="number">
            <mat-header-cell *matHeaderCellDef> Number
            </mat-header-cell>
            <mat-cell *matCellDef="let row">
              <span [innerHtml]="row.questionNumber"></span>
            </mat-cell>
          </ng-container>
          <ng-container matColumnDef="question">
            <mat-header-cell *matHeaderCellDef> Question
            </mat-header-cell>
            <mat-cell *matCellDef="let row">
              <span [innerHtml]="row.question"></span>
            </mat-cell>
          </ng-container>
          <ng-container matColumnDef="answer">
            <mat-header-cell *matHeaderCellDef> Answer
            </mat-header-cell>
            <mat-cell *matCellDef="let row">
              <span [innerHtml]="row.answer"></span>
            </mat-cell>
          </ng-container>
          <ng-container matColumnDef="buttons">
            <mat-header-cell *matHeaderCellDef="">Actions</mat-header-cell>
            <mat-cell *matCellDef="let row">
              <app-icon icon="more_verti" [matMenuTriggerFor]="QAMenu"></app-icon>
              <mat-menu #QAMenu="matMenu">
                <label mat-menu-item [disabled]="!isActive" class="cursor-pointer" 
                  (click)="openQuestionFlyPanel(questionPanel,row)">Edit</label>
                <label mat-menu-item [disabled]="!isActive" class="cursor-pointer"
                  (click)="deleteQuestion(deleteDialog,row)"><span>Delete</span></label>
              </mat-menu>
            </mat-cell>
          </ng-container>
          <mat-header-row *matHeaderRowDef="displayColumns"></mat-header-row>
          <mat-row cdkDrag (cdkDragDropped)="dropQA($event)" *matRowDef="let row; columns: displayColumns;"></mat-row>

          <!-- Row shown when there is no matching data.-->
          <tr class="mat-row flex text-center " *matNoDataRow>
            <td class="mat-cell w-full m-2">No data to display</td>
          </tr>

        </table>
        <mat-paginator #questionPaginator="matPaginator" [pageSizeOptions]="[20, 40, 60]" showFirstLastButtons
          aria-label="Select page of Question Answers">
        </mat-paginator>
      </div>
    </div>
    <div class="mainBorder pr-5 pt-4">
      <div class="flex flex-row justify-between">
        <div class="flex flex-col m-0">
          <h2 class="mb-2">SQ Specific Suggestions</h2>
          <p class="text-xs" class="text-gray-400">Showing {{suggestions.length}} SQ Specific Suggestions</p>
        </div>
      </div>
      <div class="flex flex-col">
        <table cdkDropList mat-table [dataSource]="SuggestionSource" class="table-bordered w-full">
          <ng-container matColumnDef="order">
            <mat-header-cell *matHeaderCellDef> Reorder
            </mat-header-cell>
            <mat-cell *matCellDef="let row">
              <app-icon cdkDragHandle class="pt-0 mr-2" icon="drag_indicator"
                style="color: darkgrey!important;cursor:move"></app-icon>
            </mat-cell>
          </ng-container>
          <ng-container matColumnDef="number">
            <mat-header-cell *matHeaderCellDef> Number
            </mat-header-cell>
            <mat-cell *matCellDef="let row">
              <span [innerHtml]="row.number"></span>
            </mat-cell>
          </ng-container>
          <ng-container matColumnDef="description">
            <mat-header-cell *matHeaderCellDef> Suggestion
            </mat-header-cell>
            <mat-cell *matCellDef="let row">
              <span [innerHtml]="row.description"></span>
            </mat-cell>
          </ng-container>
          <ng-container matColumnDef="buttons">
            <mat-header-cell *matHeaderCellDef="">Actions</mat-header-cell>
            <mat-cell *matCellDef="let row">
              <app-icon icon="more_verti" [matMenuTriggerFor]="suggestionMenu"></app-icon>
              <mat-menu #suggestionMenu>
                <label mat-menu-item [disabled]="!isActive" class="cursor-pointer" (click)="deleteSuggestion(deleteDialog,row)">Delete</label>
                <label mat-menu-item [disabled]="!isActive" class="cursor-pointer" (click)="openSuggestionFlyPanel(suggestionPanel,row)">Edit</label>
              </mat-menu>
            </mat-cell>
          </ng-container>
          <mat-header-row *matHeaderRowDef="suggestionDisplay"></mat-header-row>
          <mat-row cdkDrag (cdkDragDropped)="dropSuggestion($event)" *matRowDef="let row; columns: suggestionDisplay;">
          </mat-row>

          <!-- Row shown when there is no matching data.-->
          <tr class="mat-row flex text-center " *matNoDataRow>
            <td class="mat-cell w-full m-2">No data to display</td>
          </tr>

        </table>
        <mat-paginator #suggestionPaginator="matPaginator" [pageSizeOptions]="[20, 40, 60]" showFirstLastButtons
          aria-label="Select page of Question Answers">
        </mat-paginator>
      </div>
    </div>
  </div>
  <div>
    <div class="flex flex-col p-3 bottomBorder">
      <div class="flex flex-row justify-between">
        <h2>Conditions</h2>
        <app-button (clicked)="openFlyPanel(conditionsPanel)" [disabled]="!isActive" variant="text" icon="edit" iconPosition="left" text="Edit"></app-button>
      </div>
      <div [innerHtml]="conditions" class="text-sm text-gray-500">
        
      </div>
    </div>
    <div class="flex flex-col p-3 bottomBorder">
      <div class="flex flex-row justify-between">
        <h2>Criteria</h2>
        <app-button (clicked)="openFlyPanel(criteriaPanel)" [disabled]="!isActive" variant="text" icon="edit" iconPosition="left" text="Edit"></app-button>
      </div>
      <div [innerHtml]="criteria" class="text-sm text-gray-500">
      </div>
    </div>
    <div class="flex flex-col p-3 bottomBorder">
      <div class="flex flex-row justify-between">
        <h2>{{("Tool" | labelReplacement)| async}}s</h2>
        <app-button (clicked)="openFlyPanel(toolPanel)" [disabled]="!isActive" variant="text" icon="edit" iconPosition="left" text="Edit"></app-button>
      </div>
      <div class="flex flex-row flex-wrap">
        <ng-container *ngFor="let tool of tools">
          <div class="mr-2 p-2 circularBorder mb-3">
            <p class="text-xs mb-0 text-gray-500">{{tool.name}}</p>
          </div>
        </ng-container>
      </div>
    </div>
    <div class="flex flex-col p-3 bottomBorder">
      <div class="flex flex-row justify-between">
        <h2>References</h2>
        <app-button (clicked)="openFlyPanel(referencesPanel)" [disabled]="!isActive" variant="text" icon="edit" iconPosition="left" text="Edit"></app-button>
      </div>
      <div [innerHtml]="references" class="text-sm text-gray-500">

      </div>
    </div>
  </div>
</div>
</ng-container>

<ng-template #deleteDialog>
  <app-qtd-dialogue [header]="dialogTitle" [description]="dialogDesc" cancelText="No" confirmText="Yes"
    [showEffectiveDateAndReason]="true" (canceled)="dialog.closeAll()" (confirmed)="getDeleteData($event)">
  </app-qtd-dialogue>
</ng-template>

<ng-template #questionPanel>
  <app-flypanel-eo-add-questions [eoId]="eoId" (closed)="flypanelSrvc.close();closeAndRefreshQuestions()" 
      [editQuestion]="eoQuestion" (refresh)="closeAndRefreshQuestions()"></app-flypanel-eo-add-questions>
</ng-template>
<ng-template #stepPanel>
  <app-flypanel-eo-add-step [eoId]="eoId" [editStep]="selectedStep" (closed)="flypanelSrvc.close()" (refresh)="closeAndRefreshSteps()"></app-flypanel-eo-add-step>
</ng-template>
<ng-template #suggestionPanel>
  <app-flypanel-eo-add-suggestion [eoId]="eoId" (closed)="flypanelSrvc.close();closeAndRefreshSuggestion()" 
  [editSuggestion]="eoSuggestion" (refresh)="closeAndRefreshSuggestion()"></app-flypanel-eo-add-suggestion>
</ng-template>
<ng-template #conditionsPanel>
  <app-flypanel-eo-edit-conditions [eoId]="eoId" (refresh)="getEO()" [data]="conditions"
    (closed)="flypanelSrvc.close();getEO();"></app-flypanel-eo-edit-conditions>
</ng-template>
<ng-template #criteriaPanel>
  <app-flypanel-eo-edit-criteria [eoId]="eoId" (refresh)="getEO()" [data]="criteria" (closed)="flypanelSrvc.close();getEO();"></app-flypanel-eo-edit-criteria>
</ng-template>
<ng-template #referencesPanel>
  <app-flypanel-eo-edit-references [eoId]="eoId" (refresh)="getEO()" [data]="references" (closed)="flypanelSrvc.close();getEO();"></app-flypanel-eo-edit-references>
</ng-template>
<ng-template #toolPanel>
  <app-flypanel-eo-edit-tool [eoId]="eoId" (refresh)="getEO();getToolsData();" (closed)="flypanelSrvc.close();getToolsData();"></app-flypanel-eo-edit-tool>
</ng-template>

<ng-template #addStep>
  <app-flypanel-eo-add-step [editStep]="selectedStep" [eoId]="eoId" (refresh)="closeAndRefreshSteps()"
    (closed)="flypanelSrvc.close();closeAndRefreshSteps();">
  </app-flypanel-eo-add-step>
</ng-template>
