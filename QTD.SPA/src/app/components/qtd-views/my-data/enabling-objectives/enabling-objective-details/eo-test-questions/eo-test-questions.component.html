<div class="flex flex-row flex-wrap mt-3 justify-between">
  <div class="flex flex-col">
    <p class="font-bold text-lg">Linkages: Test Questions</p>
    <p class="text-xs text-gray-four">{{srcList.length}} Test Questions linked to selected {{isMeta ? 'Meta EO': ('Enabling Objective' | labelReplacement | async)}}</p>
  </div>
  <app-button *ngIf="!isMeta" (clicked)="openFlyPanel(addTest)" [disabled]="!isActive" variant="text" icon="add"
    iconPosition="left" text="Add New Test Questions">
  </app-button>
</div>

<app-data-loader *ngIf="!DataSource"></app-data-loader>
<div class="shadow-md" *ngIf="DataSource">
  <div class="flex flex-row flex-wrap bg-gray-one justify-between mb-3 mt-3  px-3 py-3 rounded"
    *ngIf="unlinkIds.length > 0">
    <p class="text-xs text-gray-four pt-2">{{unlinkIds.length}} Test Questions selected</p>
    <app-button (clicked)="openDialog(unlinkDialog)" [spinner]="spinner" [disabled]="spinner" icon="link_off" iconPosition="left" size="sm" color="secondary"
      text="Unlink Test Questions">
    </app-button>
  </div>
  <table class="w-full" mat-table [dataSource]="DataSource" matSort (matSortChange)="sortData($event)">
    <ng-container matColumnDef="id">
      <th style="width:5%;" mat-header-cell *matHeaderCellDef>
        <mat-checkbox [disabled]="!isActive || isMeta" (change)="$event ? masterToggle() : null"
          [checked]="selection.hasValue() && isAllSelected()"
          [indeterminate]="selection.hasValue() && !isAllSelected()">
        </mat-checkbox>
      </th>
      <td mat-cell *matCellDef="let row">
        <mat-checkbox [disabled]="!isActive || isMeta" (click)="$event.stopPropagation()"
          (change)="$event ? selectrow(row) : null" [checked]="selection.isSelected(row)">
        </mat-checkbox>
      </td>
    </ng-container>
    <ng-container matColumnDef="number">
      <th style="width:7%;" mat-header-cell *matHeaderCellDef mat-sort-header> #
      </th>
      <td mat-cell *matCellDef="let row"> {{row.number}} </td>
    </ng-container>
    <ng-container matColumnDef="description">
      <th style="width:auto; min-width: 40%; max-width: 77%;" mat-header-cell *matHeaderCellDef mat-sort-header> Test Question Item
      </th>
      <td style="max-width: 200px;overflow: hidden;text-overflow: ellipsis;white-space: nowrap; padding-right: 15px;" mat-cell *matCellDef="let row">
        <div class="flex">
          <span [matTooltip]="row.description" style="text-overflow: ellipsis;overflow: hidden;" [innerHTML]="row.description"></span>
        </div>
      </td>
    </ng-container>

    <ng-container matColumnDef="count">
      <th style="width:10%;" mat-header-cell *matHeaderCellDef mat-sort-header> # of Tests
      </th>
      <td mat-cell *matCellDef="let row,index as i">
        <div class="flex flex-row justify-between" style="align-items: flex-end;">
          <label (click)="selectedNumber = (i+1);selectedId = row.id;selectedTitle = row.description;openFlyPanel(linkedTo)" style="color:rgba(92, 155, 49, 1)">
            {{row.count | number: '2.0'}}
          </label>
          <app-button (clicked)="openDialog(unlinkDialog,row.id)" [disabled]="!isActive || spinner || isMeta" ButtonType="icon" icon="link_off" style="color:lightgray">
          </app-button>
        </div>
      </td>
    </ng-container>


    <ng-container>
      <th mat-header-cell *matHeaderCellDef mat-sort-header>
      </th>
      <td mat-cell *matCellDef="let row" matTooltip="Unlink Test Question">
        <app-icon icon="link_off"></app-icon>
      </td>
    </ng-container>
    <tr mat-header-row *matHeaderRowDef="displayColumns"></tr>
    <tr mat-row *matRowDef="let row; columns: displayColumns;" [class.inActiveItem]="!row.active"></tr>

    <!-- Row shown when there is no matching data.-->
    <tr class="mat-row text-center " *matNoDataRow>
      <td [attr.colSpan]="displayColumns.length" class="mat-cell w-full m-2">No data to display</td>
    </tr>

  </table>
  <mat-paginator [pageSizeOptions]="[20, 40, 60]" showFirstLastButtons aria-label="Select page of periodic elements">
  </mat-paginator>
</div>

<ng-template #addTest>
  <app-flypanel-eo-test-question-link [hasSpace]="true" (refresh)="readyData();" (closed)="flyPanelSrvc.close()">
  </app-flypanel-eo-test-question-link>
</ng-template>

<ng-template #unlinkDialog>
  <app-qtd-dialogue cancelText="No" confirmText="Yes" [header]="header" [description]="description" [showEffectiveDateAndReason]="true"
    (canceled)="dialog.closeAll()" (confirmed)="UnlinkTests($event)"></app-qtd-dialogue>
</ng-template>

<ng-template #linkedTo>
  <app-flypanel-linked-eos (closed)="flyPanelSrvc.close()" [Title]="selectedTitle" [selectedTypeNumber]="selectedNumber" [selectedType]="'Test'" [Id]="selectedId"></app-flypanel-linked-eos>
</ng-template>
