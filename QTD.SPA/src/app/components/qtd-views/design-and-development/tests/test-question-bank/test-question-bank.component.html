<app-header [crumbOnly]="'Design and Development / Tests / Test Items'"></app-header>

<div class="flex flex-col p-4 pl-5">
  <p class="text-lg font-bold">Test Question Bank</p>
  <!-- This section is for stats -->
  <app-data-loader *ngIf="statsLoader"></app-data-loader>
  <section *ngIf="!statsLoader" class="flex flex-row bg-white rounded shadow-sm" style="justify-content: space-around;">
    <div class="pr-4 mt-3 mb-3" style="border-right: 1px solid #F2F2F2;">
      <p class="m-0 pb-1">Total Active Test Questions</p>
      <p (click)="openFlyInPanelList(list,'Active')" [ngClass]="{'text-2xl text-qtd font-bold cursor-pointer':stats.active>0,'text-xl text-black':stats.active==0}">
        {{stats.active | number: '2.0'}}</p>
    </div>
    <div class="pr-4 mt-3 mb-3" style="border-right: 1px solid #F2F2F2;">
      <p class="m-0 pb-1">Total Inactive Test Questions</p>
      <p (click)="openFlyInPanelList(list,'Inactive')" [ngClass]="{'text-2xl text-red-600 font-bold cursor-pointer':stats.inactive>0,'text-xl text-black':stats.inactive==0}">
        {{stats.inactive | number: '2.0'}}</p>
    </div>
    <div class="pr-4 mt-3 mb-3" style="border-right: 1px solid #F2F2F2;">
      <p class="m-0 pb-1">Total Questions not linked to Tests</p>
      <p (click)="openFlyInPanelList(list,'Notlinked')" [ngClass]="{'text-2xl text-qtd font-bold cursor-pointer':stats.notLinkedTests>0,'text-xl text-black':stats.notLinkedTests==0}">
        {{stats.notLinkedTests | number: '2.0'}}</p>
    </div>
    <div class="mt-3 mb-3">
      <p class="m-0 pb-1">Total Questions not linked to EOs</p>
      <p (click)="openFlyInPanelList(list,'Noteo')" [ngClass]="{'text-2xl text-qtd font-bold cursor-pointer':stats.notLinkedEOs>0,'text-xl text-black':stats.notLinkedEOs==0}">
        {{stats.notLinkedEOs | number: '2.0'}}</p>
    </div>
  </section>
  <!-- this section is bulk edit, filter and add new section -->
  <section class="flex flex-row justify-between mt-5" style="align-items: baseline;">
    <app-button size="sm" (clicked)="redirectToBulkEdit()"
      ButtonType="button" variant="text" [icon]="'edit_document'" iconPosition="left" text="Bulk Edit"></app-button>
    <div class="flex flex-row">
      <app-button [customClasses]="'pl-3 pr-3'" leftIcon="filter_alt" rightIcon="expand_more"
        [matMenuTriggerFor]="filter" class="mr-2" size="sm" color="secondary" ButtonType="button" text="Filter"
        icon="keyboard_arrow_down"></app-button>
      <app-button (clicked)="questionMode='add';openFlyPanel(addQuestion)" size="sm" ButtonType="button"
        text="Add New Test Question"></app-button>
    </div>
    <mat-menu #filter="matMenu">
      <label [matMenuTriggerFor]="type" mat-menu-item class="label_style">
        Test Question Type
        <!-- <app-icon class="ml-2" icon="keyboard_arrow_right"></app-icon> -->
      </label>
      <label [matMenuTriggerFor]="taxonomy" class="label_style" mat-menu-item>
        Taxonomy Level
      </label>
      <label [matMenuTriggerFor]="status" class="label_style" mat-menu-item>
        Status
      </label>
      <label (click)="taxonomyFilter = '';typeFilter = '';statusFilter = '';filterData();clearAppliedFilters();" class="label_style"
        mat-menu-item>
        Clear Filters
      </label>
    </mat-menu>
    <mat-menu #type="matMenu">
      <label [ngClass]="{'active_menu':typeFilter === 'Multiple Choice Questions'}"
        (click)="typeFilter = 'Multiple Choice Questions';filterData();filterNamesChange('Multiple Choice Questions','type')" mat-menu-item class="label_style">
        Multiple Choice
      </label>
      <label [ngClass]="{'active_menu':typeFilter === 'Multiple Correct Answers'}"
        (click)="typeFilter = 'Multiple Correct Answers';filterData(); filterNamesChange('Multiple Correct Answers','type')" mat-menu-item class="label_style">
        Multiple Correct Answer
      </label>
      <label [ngClass]="{'active_menu':typeFilter === 'True / False'}"
        (click)="typeFilter = 'True / False';filterData(); filterNamesChange('True / False','type')" mat-menu-item class="label_style">
        True/False
      </label>
      <label [ngClass]="{'active_menu':typeFilter === 'Match The Column'}"
        (click)="typeFilter= 'Match The Column';filterData();filterNamesChange('Match The Column','type')" mat-menu-item class="label_style">
        Matching
      </label>
      <label [ngClass]="{'active_menu':typeFilter === 'Fill in the Blank'}"
        (click)="typeFilter = 'Fill in the Blank';filterData(); filterNamesChange('Fill in the Blank','type')" mat-menu-item class="label_style">
        Fill-in-the-Blank
      </label>
      <label [ngClass]="{'active_menu':typeFilter === 'Short Answers'}"
        (click)="typeFilter = 'Short Answers';filterData();filterNamesChange('Short Answers','type')" mat-menu-item class="label_style">
        Short Answer
      </label>
    </mat-menu>
    <mat-menu #status="matMenu">
      <label [ngClass]="{'active_menu':statusFilter === 'active'}" (click)="statusFilter = 'active';filterData();filterNamesChange('Active','status')"
        mat-menu-item class="label_style">
        Active
      </label>
      <label [ngClass]="{'active_menu':statusFilter === 'inactive'}" (click)="statusFilter = 'inactive';filterData();filterNamesChange('Inactive','status')"
        mat-menu-item class="label_style">
        Inactive
      </label>
    </mat-menu>
    <mat-menu #taxonomy="matMenu">
      <label [ngClass]="{'active_menu':taxonomyFilter === 'Recall'}" (click)="taxonomyFilter = 'Recall';filterData();filterNamesChange('Recall','taxonomy')"
        mat-menu-item class="label_style">
        Recall
      </label>
      <label [ngClass]="{'active_menu':taxonomyFilter === 'Application'}"
        (click)="taxonomyFilter = 'Application';filterData();filterNamesChange('Application','taxonomy')" mat-menu-item class="label_style">
        Application
      </label>
      <label [ngClass]="{'active_menu':taxonomyFilter === 'Analysis'}"
        (click)="taxonomyFilter = 'Analysis';filterData();filterNamesChange('Analysis','taxonomy')" mat-menu-item class="label_style">
        Analysis
      </label>
      <label [ngClass]="{'active_menu':taxonomyFilter === 'Evaluate'}"
        (click)="taxonomyFilter= 'Evaluate';filterData();filterNamesChange('Evaluate','taxonomy')" mat-menu-item class="label_style">
        Evaluate
      </label>
      <label [ngClass]="{'active_menu':taxonomyFilter === 'Create'}" (click)="taxonomyFilter = 'Create';filterData();filterNamesChange('Create','taxonomy')"
        mat-menu-item class="label_style">
        Create
      </label>
    </mat-menu>
  </section>

  <div class="flex flex-col ml-12 px-4 py-2 bg-white-one w-1/5 pt-2" *ngIf="filterName.length > 0">
    <span class="font-bold mb-4">Filter(s) Applied</span>
    <span *ngFor="let name of filterName">{{name}}</span>

    <!-- <app-button class="mt-4" variant="text" color="secondary" icon="close" (clicked)="clearAppliedFilters()" text="Clear all filters"></app-button> -->
  </div>

  <!-- This section is for the table and filter -->
  <section class="flex flex-col bg-white rounded shadow-sm mt-4">
    <div class="pl-3 pt-3 m-0 flex flex-row justify-between"
      style="align-items: baseline;border-bottom: 2px solid #F2F2F2;">
      <mat-form-field class="flex flex-grow bg-white" appearance="outline">
        <div class="flex flex-row">
          <mat-icon matPrefix>search</mat-icon>
          <input (input)="filterData()" [(ngModel)]="filterString" type="text" matInput
            placeholder="Enter keywords to search">
            <app-icon icon="close" class="pt-2 cursor-pointer" (click)="clearFilter()" ></app-icon>

        </div>

      </mat-form-field>
      <div class="flex flex-row pr-3 flex-wrap" style="align-items: center">
        <p class="m-0 pr-2 font-bold text-gray-400">View Question by</p>
        <app-button [matMenuTriggerFor]="viewBy" color="secondary" size="sm" [text]="selectedText"
          icon="keyboard_arrow_down" iconPosition="right"></app-button>
        <mat-menu #viewBy="matMenu">
          <label class="label_style" (click)="openFlyPanel(selectEO);" mat-menu-item>
            {{("Enabling Objective" | labelReplacement)| async}}
          </label>
          <label class="label_style" (click)="openFlyPanel(selectILA);" mat-menu-item>
            {{("ILA" | labelReplacement)| async}}
          </label>
          <label class="label_style"
            (click)="viewByFilter='unlinked';selectedText='Unlinked Test Questions';selectedId = null;readyData(viewByFilter)"
            mat-menu-item>
            Unlinked Test Questions
          </label>
        </mat-menu>
      </div>
    </div>
    <app-data-loader *ngIf="isLoading"></app-data-loader>
    <div class="table-container" [hidden]="isLoading">
      <table matSortActive="number" matSortDirection="asc" matSort mat-table class="w-full" [dataSource]="dataSource">
        <ng-container *ngIf="selectedId !== null" matColumnDef="selected">
          <th class="font-bold" mat-header-cell *matHeaderCellDef>
            <span class="font-bold text-black">
              <ng-container *ngIf="isEO; else notEO">
                EO Number/Name
              </ng-container>
              <ng-template #notEO>
                <ng-container *ngIf="'ILA' | labelReplacement | async as replacedLabel">
                  {{ replacedLabel }} Provider/Title
                </ng-container>
              </ng-template>
            </span>
          </th>
          <td mat-cell *matCellDef="let row,index as i" [style.display]="i === 0 ? '':'none'"
            [attr.rowspan]="dataSource.data.length" style="width: 20rem;border-right: 1px solid rgba(0, 0, 0, 0.12);vertical-align: top;">
            <div style="position:sticky;top:4rem;margin-top:1rem;overflow:auto;">
              {{selectedViewByDescription}}
            </div>
          </td>
        </ng-container>

        <!-- <ng-container class="w-1/2" *ngIf="selectedId === 'Ml'" matColumnDef="cb">
          <th mat-header-cell *matHeaderCellDef>
            <mat-checkbox></mat-checkbox>
          </th>
          <td mat-cell *matCellDef="let row">
            <mat-checkbox></mat-checkbox>
          </td>
        </ng-container> -->

        <ng-container matColumnDef="number">
          <th class="font-bold" mat-sort-header [ngClass]="{'pl-3': selectedId !== null}" mat-header-cell *matHeaderCellDef>
            <span class="font-bold text-black">ID</span>
          </th>
          <td [ngClass]="{'pl-3': selectedId !== null}" mat-cell *matCellDef="let row">
            {{row.number}}
          </td>
        </ng-container>

        <ng-container matColumnDef="question">
          <th class="font-bold" mat-sort-header mat-header-cell *matHeaderCellDef>
            <span class="font-bold text-black">Question Stem</span>
          </th>
          <td style="width: 30rem;word-wrap: break-word;" class="pt-3" mat-cell *matCellDef="let row">
            <div [ngClass]="row.question.trim().toLowerCase().includes('<p>') ? '':'mb-3'" class="flex flex-row"
              [innerHTML]="row.question"></div>
          </td>
        </ng-container>
        <ng-container matColumnDef="type">
          <th class="font-bold" mat-sort-header mat-header-cell *matHeaderCellDef>
            <span class="font-bold text-black">Type</span>
          </th>
          <td mat-cell *matCellDef="let row">
            {{row.type}}
          </td>
        </ng-container>
        <ng-container matColumnDef="taxonomy">
          <th class="font-bold" mat-sort-header mat-header-cell *matHeaderCellDef>
            <span class="font-bold text-black">Taxonomy Level</span>
          </th>
          <td mat-cell *matCellDef="let row">
            {{row.taxonomy}}
          </td>
        </ng-container>
        <ng-container matColumnDef="status">
          <th  mat-sort-header mat-header-cell *matHeaderCellDef>
            <span class="font-bold text-black">Status</span>
          </th>
          <td mat-cell *matCellDef="let row">
            <div class="flex w-full">
              <div
                [ngClass]="row.isActive === 'ACTIVE' ? 'active_style py-2 text-xs rounded-sm':'inactive_style p-2 text-xs rounded-sm'">
                {{row.isActive}}</div>
            </div>
          </td>
        </ng-container>
        <ng-container matColumnDef="actions">
          <th mat-header-cell *matHeaderCellDef>

          </th>
          <td mat-cell *matCellDef="let row">
            <app-icon class="cursor-pointer" style="color:gray;" [matMenuTriggerFor]="options"
              icon="more_horiz"></app-icon>
            <mat-menu #options="matMenu">
              <label (click)="selectedRow = row;questionMode='edit';openFlyPanel(addQuestion)" class="label_style"
                mat-menu-item>Edit</label>
              <label (click)="selectedRow = row;questionMode='copy';openFlyPanel(addQuestion)" class="label_style"
                mat-menu-item>Copy</label>
              <label (click)="openDeleteDialog(deleteDialog,row)" class="label_style" mat-menu-item>Delete</label>
              <label (click)="openStatusDialog(statusDialog,row)" class="label_style" mat-menu-item>Make
                Active/Inactive</label>
              <label (click)="selectedRow = row;openFlyPanel(changeEO);" class="label_style" mat-menu-item>Change
               {{("Enabling Objective" | labelReplacement)| async}}</label>
            </mat-menu>
          </td>
        </ng-container>

        <tr mat-header-row *matHeaderRowDef="(selectedId === null ? displayedColumns:displayedColumnsWithSelected);sticky:true" ></tr>
        <tr mat-row *matRowDef="let row; columns : selectedId === null ? displayedColumns:displayedColumnsWithSelected" >
        </tr>
        <tr class="mat-row" *matNoDataRow>
          <td class="mat-cell text-center" [attr.colspan]="displayedColumns.length">
            No data Found.
          </td>
        </tr>
      </table>
    </div>
    <mat-paginator [pageSizeOptions]="[20, 40 ,60]" showFirstLastButtons aria-label="Select page of periodic elements">
    </mat-paginator>
  </section>
</div>

<ng-template #addQuestion>
  <app-flypanel-add-test-item [mode]="questionMode" [previousQuestion]="selectedRow"
    (closed)="closeFlyPanel()"></app-flypanel-add-test-item>
</ng-template>

<!-- <ng-template #bulkEdit>
  <app-flypanel-bulk-edit-test-items (closed)="flyPanelService.close()"></app-flypanel-bulk-edit-test-items>
</ng-template> -->

<ng-template #selectEO>
  <app-flypanel-select-eo [selectedId]="isEO ? selectedId:null"
    (idSelected)="viewByFilter='eo';selectedText='Enabling Objectives';eoSelected($event)"
    (closed)="closeFlyPanel()"></app-flypanel-select-eo>
</ng-template>

<ng-template #selectILA>
  <app-flypanel-select-ila
    (idSelected)="viewByFilter='ila';selectedText='Individual Learning Activity';ilaSelected($event)"
    (closed)="closeFlyPanel()"></app-flypanel-select-ila>
</ng-template>

<ng-template #statusDialog>
  <app-qtd-dialogue [isHTML]="isHTML" [header]="header" [description]="description" cancelText="No" confirmText="Yes"
    [showEffectiveDateAndReason]="true" (confirmed)="statusDialogConfirmed($event);isHTML = false;"
    (canceled)="dialog.closeAll();isHTML = false;"></app-qtd-dialogue>
</ng-template>

<ng-template #changeEO>
  <app-flypanel-change-eo (changed)="closeFlyPanel();refreshData()" [testItemId]="selectedRow.id"
    (closed)="closeFlyPanel();" [eoId]="selectedRow.eoId"></app-flypanel-change-eo>
</ng-template>

<ng-template #deleteDialog>
  <app-qtd-dialogue [isHTML]="isHTML" [header]="header" [description]="description" cancelText="No" confirmText="Yes"
    [showEffectiveDateAndReason]="true" (confirmed)="deleteDialogConfirmed($event);isHTML = false;"
    (canceled)="dialog.closeAll();isHTML = false"></app-qtd-dialogue>
</ng-template>

<ng-template #list>
  <app-fly-panel-test-question-bank-list [moduleName]="moduleName"></app-fly-panel-test-question-bank-list>
</ng-template>
