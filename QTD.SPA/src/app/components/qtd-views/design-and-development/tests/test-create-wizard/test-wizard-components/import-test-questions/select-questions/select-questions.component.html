<mat-toolbar class="h-28 app-toolbar-sticky">

  <app-button type="button" ButtonType='icon' icon='arrow_back' (clicked)="goBack()">
  </app-button>

  <h1 class="flex-auto font-medium text-xl" id="title" translate>Select Test Questions by EO</h1>
  <div class="flex flex-row items-center space-x-4">

    <app-button [spinner]="showSpinner" color="secondary" (clicked)="goBack()" type="button" text="Cancel">
    </app-button>

  </div>
</mat-toolbar>

<ng-container *ngIf="linkedEOIds.length === 0">
  <div class="px-14 mt-4">
    <span class="text-small text-gray-400">No {{("Enabling Objective" | labelReplacement)| async}} linked to the test.</span>
    <br />
    <span class="text-small text-gray-400">Choose EOs from the list and view it's linked Questions to add.</span>
    <br /><br />
    <span class="font-bold underline" (click)="openFlyInPanel(linkEO)">Choose {{("Enabling Objective" | labelReplacement)| async}} <app-icon
        icon="arrow_forward"></app-icon></span>
  </div>
</ng-container>

<div class="px-14">
  <app-spinner *ngIf="isTestItemLoading" class="align-item-center"></app-spinner>
</div>

<ng-container *ngIf="linkedEOIds.length !== 0 && !isTestItemLoading">
  <div class="px-14 mt-4 flex flex-col">
    <div class="flex flex-row justify-between">
      <div class="flex flex-col">
        <span class="text-small text-gray-400">
          Choose test questions from the following and select import to add selected items to test.
        </span>
        <span class="font-bold underline mx-3" (click)="openFlyInPanel(linkEO)">Choose Other {{("Enabling Objective" | labelReplacement)| async}} <app-icon
          icon="arrow_forward"></app-icon></span>
      </div>
      <div>
        <app-button color="secondary" text="Filter" size="sm" leftIcon="filter_alt" rightIcon="expand_more"
        [matMenuTriggerFor]="filterMenu"></app-button>
        <mat-menu #filterMenu="matMenu">
          <label [matMenuTriggerFor]="type" mat-menu-item class="label_style">
            Test Question Type
            <!-- <app-icon class="ml-2" icon="keyboard_arrow_right"></app-icon> -->
          </label>
          <label [matMenuTriggerFor]="taxonomy" class="label_style" mat-menu-item>
            Taxonomy Level
          </label>
          <label (click)="taxonomyFilter = '';typeFilter = '';statusFilter = '';filterData()" class="label_style"
            mat-menu-item>
            Clear Filters
          </label>
        </mat-menu>

        <mat-menu #taxonomy="matMenu">
          <label [ngClass]="{'active_menu':taxonomyFilter === 'Recall'}" (click)="taxonomyFilter = 'Recall';filterData();"
            mat-menu-item class="label_style">
            Recall
          </label>
          <label [ngClass]="{'active_menu':taxonomyFilter === 'Application'}"
            (click)="taxonomyFilter = 'Application';filterData();" mat-menu-item class="label_style">
            Application
          </label>
          <label [ngClass]="{'active_menu':taxonomyFilter === 'Analysis'}"
            (click)="taxonomyFilter = 'Analysis';filterData();" mat-menu-item class="label_style">
            Analysis
          </label>
          <label [ngClass]="{'active_menu':taxonomyFilter === 'Evaluate'}"
            (click)="taxonomyFilter= 'Evaluate';filterData();" mat-menu-item class="label_style">
            Evaluate
          </label>
          <label [ngClass]="{'active_menu':taxonomyFilter === 'Create'}" (click)="taxonomyFilter = 'Create';filterData();"
            mat-menu-item class="label_style">
            Create
          </label>
        </mat-menu>
        <mat-menu #type="matMenu">
          <label [ngClass]="{'active_menu':typeFilter === 'Multiple Choice Questions'}"
            (click)="typeFilter = 'Multiple Choice Questions';filterData();" mat-menu-item class="label_style">
            Multiple Choice
          </label>
          <label [ngClass]="{'active_menu':typeFilter === 'Multiple Correct Answers'}"
            (click)="typeFilter = 'Multiple Correct Answers';filterData();" mat-menu-item class="label_style">
            Multiple Correct Answer
          </label>
          <label [ngClass]="{'active_menu':typeFilter === 'True / False'}"
            (click)="typeFilter = 'True / False';filterData();" mat-menu-item class="label_style">
            True/False
          </label>
          <label [ngClass]="{'active_menu':typeFilter === 'Match The Column'}"
            (click)="typeFilter= 'Match The Column';filterData();" mat-menu-item class="label_style">
            Matching
          </label>
          <label [ngClass]="{'active_menu':typeFilter === 'Fill in the Blank'}"
            (click)="typeFilter = 'Fill in the Blank';filterData();" mat-menu-item class="label_style">
            Fill-in-the-Blank
          </label>
          <label [ngClass]="{'active_menu':typeFilter === 'Short Answers'}"
            (click)="typeFilter = 'Short Answers';filterData();" mat-menu-item class="label_style">
            Short Answer
          </label>
        </mat-menu>
      </div>
    </div>
    <div class=" pt-3 m-0 flex flex-row justify-between"
          style="align-items: baseline;border-bottom: 2px solid #F2F2F2;">
          <mat-form-field class="flex flex-grow bg-white" appearance="outline">
            <mat-icon matPrefix>search</mat-icon>
            <input (input)="filterData()" [(ngModel)]="filterString" type="text" matInput
              placeholder="Enter keywords to search">
          </mat-form-field>

        </div>

    <div class="flex flex-row flex-wrap bg-gray-one justify-between mb-3 mt-3  px-3 py-3 rounded"
      *ngIf="linkIds.length > 0">
      <p class="text-xs text-gray-four pt-2">{{linkIds.length}} Test Questions have been selected</p>
      <app-button (clicked)="linkTestItems()" [spinner]="isLinkingTestItem" [disabled]="isLinkingTestItem" size="sm"
        color="secondary" text="Import to Test">
      </app-button>
    </div>
    <table #table="matTable" mat-table class="w-full" #sort="matSort" matSort [dataSource]="dataSource" >
      <ng-container matColumnDef="eoName">
        <th mat-header-cell *matHeaderCellDef mat-sort-header>
          {{("Enabling Objective" | labelReplacement)| async}} Number/ Name
        </th>
        <td style="vertical-align: top;" class="py-2 pr-2" [ngClass]="selection.selected.includes(row) ? 'greenText':''" mat-cell *matCellDef="let row,index as i" [ngStyle]="{'display':row.shouldUse ? 'table-cell':'none'}"
          [attr.rowspan]="getRowSpan(row)">
          {{row.eoName}}
        </td>
      </ng-container>

      <ng-container matColumnDef="cb">
        <th mat-header-cell *matHeaderCellDef>
          <mat-checkbox (change)="$event ? masterToggle() : null" [checked]="selection.hasValue() && isAllSelected()"
            [indeterminate]="selection.hasValue() && !isAllSelected()"></mat-checkbox>
        </th>
        <td mat-cell *matCellDef="let row">
          <mat-checkbox (click)="$event.stopPropagation()" (change)="$event ? selectrow(row) : null"
            [checked]="selection.isSelected(row)"></mat-checkbox>

        </td>
      </ng-container>



      <!-- <ng-container matColumnDef="number">
        <th mat-header-cell *matHeaderCellDef mat-sort-header>
          ID
        </th>
        <td [ngClass]="selection.selected.includes(row) ? 'greenText':''" mat-cell *matCellDef="let row">
          {{row.number}}
        </td>
      </ng-container> -->

      <ng-container matColumnDef="question">
        <th mat-header-cell *matHeaderCellDef> Question Stem </th>
        <td class="pr-2" [ngClass]="selection.selected.includes(row) ? 'greenText':''" mat-cell *matCellDef="let row">
          <div [innerHTML]="row.question" [ngClass]="row.question.includes('<p>') ? 'innerParaMargin':''"></div>
        </td>
      </ng-container>

      <ng-container matColumnDef="type">
        <th mat-header-cell *matHeaderCellDef> Type </th>
        <td class="pr-2" [ngClass]="selection.selected.includes(row) ? 'greenText':''" mat-cell *matCellDef="let row"> {{row.type}} </td>
      </ng-container>

      <ng-container matColumnDef="taxonomyLevel">
        <th mat-header-cell *matHeaderCellDef> Taxonomy Level </th>
        <td class="pr-2" [ngClass]="selection.selected.includes(row) ? 'greenText':''" mat-cell *matCellDef="let row"> {{row.taxonomyLevel}} </td>
      </ng-container>

      <ng-container matColumnDef="id">
        <th mat-header-cell *matHeaderCellDef> </th>
        <td mat-cell *matCellDef="let row">
          <app-button ButtonType="button" variant="text" [icon]="'visibility'" iconPosition="left" text="Preview"
            (clicked)="openFlyInPanel(previewTestQuestion)"
            (clicked)="selectedRow = row;openPreviewFlyInPanel(previewTestQuestion, row)"></app-button>
        </td>
      </ng-container>


      <tr mat-row *matHeaderRowDef="displayColumns"></tr>
      <tr mat-row *matRowDef="let row; columns : displayColumns"></tr>
      <tr class="mat-row text-center " *matNoDataRow>
        <td [attr.colspan]="displayColumns.length" class="mat-cell w-full m-2">No Data Found</td>
      </tr>
    </table>
  </div>


</ng-container>


<ng-template #linkEO>
  <app-flypanel-link-enabling-objective [alreadyLinked]="linkedEOIds" (closed)="flyPanelService.close()"
    (linkedEOs)="ViewLinkedEOs($event);"></app-flypanel-link-enabling-objective>

</ng-template>

<ng-template #previewTestQuestion>
  <app-flypanel-preview-test-questions (closed)="close()"
    [previousQuestion]="selectedRow"></app-flypanel-preview-test-questions>
</ng-template>
