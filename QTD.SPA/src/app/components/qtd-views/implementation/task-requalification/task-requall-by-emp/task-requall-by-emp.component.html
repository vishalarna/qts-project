<div class="flex flex-col w-full p-5">
  <section class="flex flex-col mb-3">
    <div class="flex flex-row cursor-pointer" (click)="closed.emit()" style="align-items:baseline;">
      <app-icon icon="keyboard_arrow_left" class="linkText mr-3"></app-icon>
      <span class="text-xs font-thin linkText">{{("Task" | labelReplacement)| async}} Requalification main view</span>
    </div>
  </section>
  <app-data-loader *ngIf="!employee"></app-data-loader>
  <section *ngIf="employee" class="flex flex-col bg-white rounded-sm mat-elevation-z3 mb-3">
    <div class="flex flex-row p-3" style="align-items:baseline;">
      <div class="mr-3">Filter By {{("Employee" | labelReplacement) | async}}:</div>
      <span class="linkText">{{employee.employee.person.firstName + ' ' + employee.employee.person.lastName}}</span>
    </div>
  </section>

  <div class="flex justify-end space-x-4 text-sm my-3">
    <div class="dropdown">
      <app-button
        color="secondary"
        text="Filter"
        size="sm"
        icon="filter_alt"
        iconPosition="left"
        (click)="openFlyPanel(filterEmpTaskQual)"
      >
      </app-button>
    </div>
</div>

<section *ngIf="displayFilterValues" class="flex flex-col bg-white rounded-sm mat-elevation-z3 mb-5">
  <div class="flex flex-row p-3" style="align-items:baseline;">
    <div class="mr-3">Filter By :</div>
    <span class="linkText">{{displayFilterValues}}</span>
  </div>
</section>

  <app-data-loader *ngIf="empLoader"></app-data-loader>
  <section *ngIf="!empLoader" class="flex flex-col w-full">
    <mat-form-field class="bg-white border-b-2" appearance="outline">
      <mat-icon matPrefix>search</mat-icon>
      <input (keyup)="searchUpdate($event)" [value]="searchText" type="text" matInput placeholder="Enter keywords to search">
    </mat-form-field>
    <table (matSortChange)="sortChanged($event)" matSortActive="taskNumber" matSortDirection="asc" matSort class="w-full mat-elevation-z3 rounded-sm" [dataSource]="dataSource" mat-table>

      <ng-container matColumnDef="taskNumber">
        <th style="width:7%" mat-sort-header class="pt-2" mat-header-cell *matHeaderCellDef>
          {{("Task" | labelReplacement)| async}} #
        </th>
        <td mat-cell *matCellDef="let row">
          <div class="flex flex-row">
            {{row.taskNumber}}
          </div>
        </td>
      </ng-container>

      <ng-container matColumnDef="taskDescription">
        <th mat-sort-header class="pt-2" style="width:25%" mat-header-cell *matHeaderCellDef>
          Description
        </th>
        <td mat-cell *matCellDef="let row">
          <span class="cursor-pointer" (click)="navigateToTask(row)">
            {{row.taskDescription}}
          </span>
        </td>
      </ng-container>
      <ng-container matColumnDef="posNames">
        <th mat-sort-header class="pt-2" style="width:10%" mat-header-cell *matHeaderCellDef>
          {{("Position" | labelReplacement)| async}}
        </th>
        <td mat-cell *matCellDef="let row">
          <span class="cursor-pointer" (click)="navigateToTask(row)">
            {{row.posNames}}
          </span>
        </td>
      </ng-container>

      <ng-container matColumnDef="evaluatorName">
        <th mat-sort-header class="pt-2" style="width:12%" mat-header-cell *matHeaderCellDef>
          Qualification Date / Evaluator
        </th>
        <td mat-cell *matCellDef="let row">
          <div class="flex flex-col">
            <span>{{row.qualificationDate === null ? "N/A" :
              (row.qualificationDate |  dateFormat | async)}}</span>
            <span class="linkText" [innerHtml] = "row.evaluatorName"></span>
          </div>
        </td>
      </ng-container>

      <ng-container matColumnDef="empReleaseDate">
        <th mat-sort-header class="pt-2" style="width:10%;" mat-header-cell *matHeaderCellDef>
          EMP Release Date
        </th>
        <td mat-cell *matCellDef="let row">
          <span>{{row.empReleaseDate === null ? "N/A" : (row.empReleaseDate |
            dateFormat | async)}}</span>
        </td>
      </ng-container>

      <ng-container matColumnDef="dueDate">
        <th mat-sort-header class="pt-2" style="width:10%;" mat-header-cell *matHeaderCellDef>
          Due Date
        </th>
        <td mat-cell *matCellDef="let row">
          <span>{{row.dueDate === null ? "N/A" : (row.dueDate |
            dateFormat | async)}}</span>
        </td>
      </ng-container>

      <ng-container matColumnDef="criteriaMet">
        <th mat-sort-header class="pt-2" style="width:8%;" mat-header-cell *matHeaderCellDef>
          Criteria Met
        </th>
        <td mat-cell *matCellDef="let row">
          {{row.criteriaMet ? 'Y':'N'}}
        </td>
      </ng-container>

      <ng-container matColumnDef="status">
        <th mat-sort-header class="pt-2" style="width:18%" mat-header-cell *matHeaderCellDef>
          Status
        </th>
        <td mat-cell *matCellDef="let row">
          <div class="flex flex-row" style="align-items:center">
            <div
              [ngClass]="{'initial':row.status.trim().toLowerCase() !== 'overdue','overdue':row.status.trim().toLowerCase() === 'overdue'}"
              class="rounded-sm py-1 px-1 common text-center">
              <span class="font-bold text-xs">{{row.status}}</span>
            </div>
          </div>
        </td>
      </ng-container>

      <ng-container matColumnDef="comments">
        <th mat-sort-header class="pt-2" style="width:20%" mat-header-cell *matHeaderCellDef>
          Comments
        </th>
        <td mat-cell *matCellDef="let row">
          <span class="tq-comments" [innerHTML] = "row.comments ?? 'No Comments'"></span>
        </td>
      </ng-container>

      <ng-container matColumnDef="actions">
        <th class="pt-2" mat-header-cell *matHeaderCellDef>

        </th>
        <td mat-cell *matCellDef="let row">
          <app-icon [matMenuTriggerFor]="actions" icon="more_horiz" class="text-gray-400 cursor-pointer"></app-icon>
          <mat-menu #actions="matMenu">
            <label (click)="mode='add';selectedData = row;openFlyPanel(addQualification)" class="label_style"
              mat-menu-item>Add</label>
            <label (click)="mode='edit';selectedData = row;openFlyPanel(addQualification)" class="label_style"
              mat-menu-item>Edit</label>
            <label (click)="selectedData = row;openDeleteDialog(deleteDialog)" class="label_style"
              mat-menu-item>Delete</label>
            <label (click)="selectedData = row;openFlyPanel(taskQualified)" class="label_style" mat-menu-item>View
              All</label>
          </mat-menu>
        </td>
      </ng-container>

      <tr style="vertical-align: top;" mat-header-row class="pl-2 pr-2" *matHeaderRowDef="displayedColumns"></tr>
      <tr mat-row class="pr-2 pl-2" *matRowDef="let row; columns: displayedColumns"></tr>
      <!-- Row shown when there is no matching data.-->
      <tr class="mat-row" *matNoDataRow>
        <td class="mat-cell text-center" [attr.colspan]="displayedColumns.length">No {{("Task" | labelReplacement)| async}} Qualifications Found</td>
      </tr>
    </table>
  </section>
</div>

<ng-template #taskQualified>
  <app-flypanel-task-qualified [taskId]="selectedData.taskId" [empId]="selectedData.empId"
    (closed)="flyPanelService.close()"></app-flypanel-task-qualified>
</ng-template>

<ng-template #addQualification>
  <app-flypanel-add-task-qualification [mode]="mode" [data]="selectedData" (closed)="flyPanelService.close()"
    (refresh)="refreshData($event);"></app-flypanel-add-task-qualification>
</ng-template>

<ng-template #deleteDialog>
  <app-qtd-dialogue header="Delete {{('Task' | labelReplacement)| async}} Qualification" [description]="description"
    [showEffectiveDateAndReason]="false" (canceled)="dialog.closeAll()" (confirmed)="deleteData($event);"
    [cancelText]="'No'" [confirmText]="'Yes'"></app-qtd-dialogue>
</ng-template>

<ng-template #filterEmpTaskQual>
  <app-flypanel-filter-employee-task-qualification [filterTaskEmpValue]="filterValues"  (empTaskQualFilterChange)="getEmpTaskQualFilterValues($event)"></app-flypanel-filter-employee-task-qualification>
</ng-template>