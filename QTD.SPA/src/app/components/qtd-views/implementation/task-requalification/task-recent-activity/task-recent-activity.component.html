<app-data-loader *ngIf="spinner"></app-data-loader>
<div [hidden]="spinner" class="pt-3 w-full flex flex-col">
  <table matSort class="w-full mat-elevation-z3 rounded-sm" [dataSource]="dataSource" mat-table>
    <ng-container matColumnDef="empName">
      <th mat-sort-header style="width:25%" mat-header-cell *matHeaderCellDef>
        {{("Employee" | labelReplacement)| async}} Name
      </th>
      <td mat-cell *matCellDef="let row">
        <div class="flex flex-row">
          <img [src]="row.empImage" onerror="this.src='assets/img/ImageNotFound.jpg'"
            class="rounded-full mr-2 mt-1" style="width:2rem;height:2rem">
          <div class="flex flex-col">
            <span class="font-bold">{{row.empName}}</span>
            <span class="text-xs text-gray-400 font-thin">{{row.empEmail}}</span>
          </div>
        </div>
      </td>
    </ng-container>

    <ng-container matColumnDef="taskNumber">
      <th mat-sort-header style="width:7%" mat-header-cell *matHeaderCellDef>
        {{("Task" | labelReplacement)| async}}/SQ No.
      </th>
      <td mat-cell *matCellDef="let row">
        <span>
          {{row.taskNumber}}
        </span>
      </td>
    </ng-container>

    <ng-container matColumnDef="evaluatorName">
      <th mat-sort-header style="width:15%" mat-header-cell *matHeaderCellDef>
        Qualification Date / Evaluator
      </th>
      <td mat-cell *matCellDef="let row">
        <div class="flex flex-col">
          <span class="text-xs font-thin text-gray-400">{{row.qualificationDate ? (row.qualificationDate |
            date:'MM/dd/yyyy, h:mm a'):"N/A"}}</span>
          <span class="linkText">{{row.evaluatorName}}</span>
        </div>
      </td>
    </ng-container>

    <ng-container matColumnDef="dueDate">
      <th mat-sort-header style="width:8%;" mat-header-cell *matHeaderCellDef>
        Due Date
      </th>
      <td mat-cell *matCellDef="let row">
        <span class="text-xs font-medium">{{row.dueDate ? (row.dueDate | date:'MM/dd/yyyy'):"N/A"}}</span>
      </td>
    </ng-container>

    <ng-container matColumnDef="criteriaMet">
      <th mat-sort-header style="width:8%;" mat-header-cell *matHeaderCellDef>
        Criteria Met (Y/N)
      </th>
      <td mat-cell *matCellDef="let row">
        {{row.criteriaMet ? 'Y':'N'}}
      </td>
    </ng-container>

    <ng-container matColumnDef="status">
      <th mat-sort-header style="width:18%" mat-header-cell *matHeaderCellDef>
        (Re)Qualification Status
      </th>
      <td mat-cell *matCellDef="let row">
        <div class="flex flex-row" style="align-items:center">
          <div class="rounded-sm py-1 common text-center"
            [ngClass]="{'initial':row.status.trim().toLowerCase() !== 'overdue','overdue':row.status.trim().toLowerCase() === 'overdue'}">
            <span class="font-bold text-xs">{{row.status}}</span>
          </div>
          <app-icon [matTooltip]="row.toolTip" icon="help_outline" class="text-gray-400 font-thin ml-2"></app-icon>
        </div>
      </td>
    </ng-container>

    <ng-container matColumnDef="requiredRequals">
      <th mat-sort-header style="width:12%" mat-header-cell *matHeaderCellDef>
        Total Required {{("Task" | labelReplacement)| async}} Requalifications
      </th>
      <td mat-cell *matCellDef="let row">
        {{row.requiredRequals === null || row.requiredRequals === '' ? "N/A":row.requiredRequals}}
      </td>
    </ng-container>

    <ng-container matColumnDef="comments">
      <th mat-sort-header style="width:11%;" mat-header-cell *matHeaderCellDef>
        Comments
      </th>
      <td mat-cell *matCellDef="let row">
        <span class="tq-comments" [innerHTML] = 'row.comments'></span>
      </td>
    </ng-container>

    <ng-container matColumnDef="actions">
      <th mat-header-cell *matHeaderCellDef>

      </th>
      <td mat-cell *matCellDef="let row">
        <app-icon [matMenuTriggerFor]="actions" icon="more_horiz" class="bg-gray-400 cursor-pointer"></app-icon>
        <mat-menu #actions="matMenu">
          <label (click)="openFlyPanel(taskQualPanel,row);" class="label_style" mat-menu-item>Edit</label>
          <label (click)="openDialog(deleteDialog,row);" class="label_style" mat-menu-item>Delete</label>
        </mat-menu>
      </td>
    </ng-container>

    <tr style="vertical-align: top;" mat-header-row class="pl-2 pr-2" *matHeaderRowDef="displayedColumns"></tr>
    <tr mat-row class="pr-2 pl-2" *matRowDef="let row; columns: displayedColumns"></tr>
    <!-- Row shown when there is no matching data.-->
    <tr class="mat-row" *matNoDataRow>
      <td class="mat-cell text-center" [attr.colspan]="displayedColumns.length">No {{("Task" | labelReplacement)| async}} Qualifications Found</td>
    </tr>
  </table>
  <mat-paginator [pageSizeOptions]="[20, 40, 60]" showFirstLastButtons #paginator="matPaginator">

  </mat-paginator>
</div>

<ng-template #taskQualPanel>
  <app-flypanel-add-task-qualification [data]="selectedData" (closed)="flyPanelService.close()"
    [mode]="mode" (refresh)="readyData();flyPanelService.close();refreshStats();"></app-flypanel-add-task-qualification>
</ng-template>

<ng-template #deleteDialog>
  <app-qtd-dialogue [cancelText]="'No'" [confirmText]="'Yes'" [showEffectiveDateAndReason]="false"
    [description]="description" [header]="header" (canceled)="dialog.closeAll()"
    (confirmed)="deleteData($event)"></app-qtd-dialogue>
</ng-template>
